<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>תמלול עברית AI - Hebrew Audio Transcription</title>
    <meta name="description" content="תמלול אודיו לטקסט בעברית באמצעות בינה מלאכותית">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', 'Arial', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; line-height: 1.6; }
        .container { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 40px; max-width: 900px; width: 100%; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); }
        .header { text-align: center; margin-bottom: 40px; }
        .title { font-size: 2.5rem; font-weight: 700; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; }
        .subtitle { color: #666; font-size: 1.1rem; margin-bottom: 20px; }
        .upload-area { border: 3px dashed #667eea; border-radius: 15px; padding: 60px 20px; text-align: center; margin-bottom: 30px; transition: all 0.3s ease; cursor: pointer; background: rgba(102, 126, 234, 0.05); }
        .upload-area:hover { border-color: #764ba2; background: rgba(118, 75, 162, 0.1); transform: translateY(-2px); }
        .upload-icon { font-size: 4rem; color: #667eea; margin-bottom: 20px; }
        .upload-text { font-size: 1.3rem; color: #333; margin-bottom: 10px; font-weight: 600; }
        .file-input { display: none; }
        .options { background: rgba(102, 126, 234, 0.05); border-radius: 15px; padding: 25px; margin-bottom: 30px; }
        .option-group { margin-bottom: 20px; }
        .option-label { display: block; margin-bottom: 12px; font-weight: 600; color: #333; font-size: 1.1rem; }
        .api-input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; margin-bottom: 15px; transition: border-color 0.3s ease; }
        .api-input:focus { outline: none; border-color: #667eea; }
        .option-row { display: flex; align-items: center; gap: 15px; margin-bottom: 12px; flex-wrap: wrap; }
        .toggle { position: relative; width: 50px; height: 25px; background: #ddd; border-radius: 25px; cursor: pointer; transition: all 0.3s ease; }
        .toggle.active { background: #667eea; }
        .toggle::after { content: ''; position: absolute; width: 21px; height: 21px; border-radius: 50%; background: white; top: 2px; left: 2px; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); }
        .toggle.active::after { transform: translateX(25px); }
        .slider-container { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .slider { flex: 1; height: 6px; border-radius: 3px; background: #ddd; outline: none; opacity: 0.7; transition: opacity 0.2s; }
        .slider-container.disabled { opacity: 0.6; }
        .slider-value { min-width: 40px; font-weight: 600; color: #667eea; }
        .file-info { background: rgba(40, 167, 69, 0.1); border-radius: 10px; padding: 15px; margin-bottom: 20px; display: none; border-right: 4px solid #28a745; }
        .file-name { font-weight: 600; }
        .file-size { font-size: 0.9rem; }
        .audio-preview { background: rgba(102, 126, 234, 0.1); border-radius: 10px; padding: 15px; margin: 15px 0; display: none; }
        .audio-player { width: 100%; height: 40px; }
        .waveform-canvas { width: 100%; max-width: 600px; height: 100px; border: 1px solid #ddd; border-radius: 8px; background: #f8f9fa; }
        .button { border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-align: center; }
        .process-button { background: linear-gradient(135deg, #17a2b8, #138496); color: white; padding: 8px 16px; font-size: 1rem; }
        .copy-button { background: #f0f0f0; color: #333; padding: 10px 15px; font-size: 0.9rem; }
        .transcribe-button { width: 100%; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 18px; border-radius: 15px; font-size: 1.3rem; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3); margin-bottom: 30px; }
        .transcribe-button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .download-button { background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 10px 20px; }
        .download-button.vtt { background: linear-gradient(135deg, #fd7e14, #ffc107); }
        .result-area { background: white; border-radius: 15px; padding: 25px; border: 2px solid #f0f0f0; margin-top: 20px; display: none; }
        .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0; flex-wrap: wrap; gap: 10px; }
        .result-title { font-size: 1.3rem; font-weight: 600; color: #333; }
        .result-actions { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .transcript-text { font-size: 1.1rem; line-height: 1.8; color: #333; background: #f8f9fa; padding: 20px; border-radius: 10px; border-right: 4px solid #667eea; min-height: 200px; white-space: pre-wrap; font-family: 'Arial', sans-serif; }
        .status { text-align: center; margin: 20px 0; font-weight: 600; display: none; }
        .loading-spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .reset-button { position: fixed; bottom: 20px; left: 20px; background: none; border: none; color: #666; cursor: pointer; font-size: 0.9rem; text-decoration: underline; padding: 5px; font-family: inherit; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">תמלול עברית AI</h1>
            <p class="subtitle">המר אודיו לטקסט בעברית באמצעות בינה מלאכותית מתקדמת</p>
        </div>
        
        <div class="options">
             <div class="option-group">
                <label class="option-label">⚙️ בחר שירות תמלול</label>
                <select id="serviceSelector" class="api-input">
                    <option value="openai" selected>OpenAI Whisper</option>
                    <option value="ivritai">Ivrit.ai (via RunPod)</option>
                </select>
            </div>
            
            <div id="openaiSettings">
                <div class="option-group">
                    <label class="option-label">🔑 מפתח OpenAI API</label>
                    <input type="password" id="apiKey" class="api-input" placeholder="sk-proj-...">
                </div>
            </div>

            <div id="ivritaiSettings" class="hidden">
                 <div class="option-group">
                    <label class="option-label">☁️ כתובת Cloudflare Proxy</label>
                    <input type="text" id="proxyUrl" class="api-input" placeholder="https://your-worker.username.workers.dev">
                </div>
                <div class="option-group">
                    <label class="option-label">🚀 מזהה RunPod Endpoint</label>
                    <input type="text" id="endpointId" class="api-input" placeholder="p8xJj85vV4i7y...">
                </div>
                 <div class="option-group">
                    <label class="option-label">🔑 מפתח RunPod API</label>
                    <input type="password" id="runpodApiKey" class="api-input" placeholder="ABCD123...">
                </div>
            </div>
        </div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">🎤</div>
            <div class="upload-text">גרור קובץ אודיו לכאן או לחץ לבחירה</div>
            <input type="file" id="fileInput" class="file-input" accept="audio/*,video/*">
        </div>

        <div class="file-info" id="fileInfo">
            <div class="file-name" id="fileName"></div>
            <div class="file-size" id="fileSize"></div>
        </div>
        <div class="audio-preview" id="audioPreview">
             <div class="audio-controls">
                <audio controls class="audio-player" id="audioPlayer"></audio>
            </div>
            <div class="canvas-container">
                <canvas class="waveform-canvas" id="waveformCanvas" width="600" height="100"></canvas>
            </div>
        </div>
        
        <div class="options">
            <div class="option-group">
                <label class="option-label">🔧 הגדרות עיבוד אודיו</label>
                <div class="option-row">
                    <span>הפעל מסנן רעשים</span>
                    <div class="toggle active" id="noiseReductionToggle"></div>
                </div>
                <div class="slider-container" id="noiseSliderContainer">
                    <span>רמת מסנן רעשים:</span>
                    <input type="range" class="slider" id="noiseReductionLevel" min="0" max="100" value="30">
                    <span class="slider-value" id="noiseReductionValue">30%</span>
                </div>
                <div class="option-row">
                    <span>נרמול עוצמת קול</span>
                    <div class="toggle active" id="normalizeToggle"></div>
                </div>
                <div class="slider-container" id="volumeSliderContainer">
                    <span>עוצמת קול יעד:</span>
                    <input type="range" class="slider" id="volumeLevel" min="50" max="150" value="100">
                    <span class="slider-value" id="volumeValue">100%</span>
                </div>
                <button class="button process-button" id="processButton" disabled style="width: 100%; margin-top: 15px; padding: 12px;">עבד אודיו</button>
            </div>
        </div>

        <div class="options">
             <div class="option-group">
                <label class="option-label">📝 הגדרות תצוגה</label>
                 <div class="option-row"><span>חותמות זמן</span><div class="toggle" id="timestampToggle"></div></div>
                <div class="option-row"><span>הצג כפסקאות</span><div class="toggle" id="paragraphToggle"></div></div>
            </div>
        </div>

        <button class="button transcribe-button" id="transcribeButton" disabled>התחל תמלול</button>
        <div class="loading-spinner" id="loadingSpinner"></div>
        <div class="status" id="status"></div>

        <div class="result-area" id="resultArea">
            <div class="result-header">
                <div class="result-title">תוצאת התמלול</div>
                <div class="result-actions">
                    <button class="button copy-button" id="copyButton">העתק הכל</button>
                    <button class="button download-button" id="downloadTxtButton">הורד כ-TXT</button>
                    <button class="button download-button vtt" id="downloadVttButton">הורד כ-VTT</button>
                </div>
            </div>
            <div class="transcript-text" id="transcriptText" contenteditable="true" style="margin-top: 15px;"></div>
        </div>

        <button id="resetButton" class="reset-button">איפוס</button>
    </div>

    <script>
        let selectedFile = null, processedFile = null, transcriptResult = null, audioContext = null;

        const elements = {
            serviceSelector: document.getElementById('serviceSelector'),
            openaiSettings: document.getElementById('openaiSettings'),
            ivritaiSettings: document.getElementById('ivritaiSettings'),
            apiKey: document.getElementById('apiKey'),
            proxyUrl: document.getElementById('proxyUrl'),
            endpointId: document.getElementById('endpointId'),
            runpodApiKey: document.getElementById('runpodApiKey'),
            uploadArea: document.getElementById('uploadArea'),
            fileInput: document.getElementById('fileInput'),
            fileInfo: document.getElementById('fileInfo'),
            fileName: document.getElementById('fileName'),
            fileSize: document.getElementById('fileSize'),
            audioPreview: document.getElementById('audioPreview'),
            audioPlayer: document.getElementById('audioPlayer'),
            waveformCanvas: document.getElementById('waveformCanvas'),
            processButton: document.getElementById('processButton'),
            transcribeButton: document.getElementById('transcribeButton'),
            loadingSpinner: document.getElementById('loadingSpinner'),
            status: document.getElementById('status'),
            resultArea: document.getElementById('resultArea'),
            transcriptText: document.getElementById('transcriptText'),
            downloadTxtButton: document.getElementById('downloadTxtButton'),
            downloadVttButton: document.getElementById('downloadVttButton'),
            copyButton: document.getElementById('copyButton'),
            resetButton: document.getElementById('resetButton'),
            noiseReductionToggle: document.getElementById('noiseReductionToggle'),
            noiseReductionLevel: document.getElementById('noiseReductionLevel'),
            normalizeToggle: document.getElementById('normalizeToggle'),
            volumeLevel: document.getElementById('volumeLevel'),
            timestampToggle: document.getElementById('timestampToggle'),
            paragraphToggle: document.getElementById('paragraphToggle'),
        };

        const storage = {
            save(key, value) { try { if(value) localStorage.setItem(key, value); } catch (e) { console.warn(`Could not save ${key}`, e); } },
            load(key) { try { return localStorage.getItem(key) || ''; } catch (e) { console.warn(`Could not load ${key}`, e); return ''; } }
        };

        const fileToBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });
        const formatVttTime = (seconds) => new Date(seconds * 1000).toISOString().substr(11, 12);
        const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));

        function checkButtonsState() {
            const service = elements.serviceSelector.value;
            let hasCredentials = false;
            if (service === 'openai') {
                hasCredentials = !!elements.apiKey.value.trim();
            } else {
                hasCredentials = !!elements.proxyUrl.value.trim() && !!elements.endpointId.value.trim() && !!elements.runpodApiKey.value.trim();
            }
            const hasFile = selectedFile || processedFile;
            elements.transcribeButton.disabled = !hasFile || !hasCredentials;
            elements.processButton.disabled = !selectedFile;
        }

        function showStatus(message, type = 'processing') {
            elements.status.className = `status ${type}`;
            elements.status.textContent = message;
            elements.status.style.display = 'block';
        }
        
        function resetApp() {
            if (!confirm('האם לאפס את האפליקציה?')) return;
            selectedFile = null; processedFile = null; transcriptResult = null;
            elements.fileInfo.style.display = 'none';
            elements.audioPreview.style.display = 'none';
            elements.resultArea.style.display = 'none';
            elements.fileInput.value = '';
            showStatus('', 'success');
            elements.status.style.display = 'none';
            checkButtonsState();
        }
        
        function initAudioContext() { if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)(); }

        function drawWaveform(file) {
            const canvas = elements.waveformCanvas;
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#667eea';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('טוען צורת גל...', canvas.width / 2, canvas.height / 2);
            
            file.arrayBuffer().then(arrayBuffer => {
                if (audioContext) {
                    return audioContext.decodeAudioData(arrayBuffer);
                }
                return Promise.reject('No audio context');
            }).then(audioBuffer => {
                drawAudioWaveform(ctx, canvas, audioBuffer);
            }).catch(error => {
                console.warn('Could not draw waveform:', error);
            });
        }

        function drawAudioWaveform(ctx, canvas, audioBuffer) {
            const data = audioBuffer.getChannelData(0);
            const step = Math.ceil(data.length / canvas.width);
            const amp = canvas.height / 2;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 1;
            ctx.beginPath();
            
            for (let i = 0; i < canvas.width; i++) {
                let min = 1.0;
                let max = -1.0;
                
                for (let j = 0; j < step; j++) {
                    const datum = data[(i * step) + j];
                    if (datum < min) min = datum;
                    if (datum > max) max = datum;
                }
                
                ctx.moveTo(i, (1 + min) * amp);
                ctx.lineTo(i, (1 + max) * amp);
            }
            ctx.stroke();
        }

        async function processAudio(file) {
            const arrayBuffer = await file.arrayBuffer();
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
            const offlineContext = new OfflineAudioContext(audioBuffer.numberOfChannels, audioBuffer.length, audioBuffer.sampleRate);
            const source = offlineContext.createBufferSource();
            source.buffer = audioBuffer;
            let currentNode = source;
            if (elements.noiseReductionToggle.classList.contains('active')) {
                const noiseReduction = offlineContext.createBiquadFilter();
                noiseReduction.type = 'highpass';
                noiseReduction.frequency.value = Math.min(200 + (elements.noiseReductionLevel.value * 3), 800);
                currentNode.connect(noiseReduction);
                currentNode = noiseReduction;
            }
            if (elements.normalizeToggle.classList.contains('active')) {
                const compressor = offlineContext.createDynamicsCompressor();
                compressor.threshold.value = -24; compressor.knee.value = 30; compressor.ratio.value = 12;
                currentNode.connect(compressor);
                currentNode = compressor;
            }
            const volumeLevel = elements.volumeLevel.value / 100;
            if (volumeLevel !== 1) {
                const gainNode = offlineContext.createGain();
                gainNode.gain.value = volumeLevel;
                currentNode.connect(gainNode);
                currentNode = gainNode;
            }
            currentNode.connect(offlineContext.destination);
            source.start();
            const processedBuffer = await offlineContext.startRendering();
            const wavBlob = bufferToWaveFile(processedBuffer);
            return new File([wavBlob], "processed.wav", {type: "audio/wav"});
        }

        function bufferToWaveFile(audioBuffer) {
            const [numberOfChannels, sampleRate] = [audioBuffer.numberOfChannels, audioBuffer.sampleRate];
            const bitsPerSample = 16; const bytesPerSample = bitsPerSample / 8;
            const length = audioBuffer.length * numberOfChannels * bytesPerSample + 44;
            const buffer = new ArrayBuffer(length); const view = new DataView(buffer);
            let pos = 0;
            const writeString = (str) => { for (let i = 0; i < str.length; i++) view.setUint8(pos + i, str.charCodeAt(i)); pos += str.length; };
            const writeUint32 = (data) => { view.setUint32(pos, data, true); pos += 4; };
            const writeUint16 = (data) => { view.setUint16(pos, data, true); pos += 2; };
            writeString('RIFF'); writeUint32(length - 8); writeString('WAVE'); writeString('fmt ');
            writeUint32(16); writeUint16(1); writeUint16(numberOfChannels); writeUint32(sampleRate);
            writeUint32(sampleRate * numberOfChannels * bytesPerSample); writeUint16(numberOfChannels * bytesPerSample);
            writeUint16(bitsPerSample); writeString('data'); writeUint32(length - pos - 4);
            const channels = Array.from({ length: numberOfChannels }, (_, i) => audioBuffer.getChannelData(i));
            let offset = 0; const maxValue = 32767;
            while (pos < length) {
                for (let i = 0; i < numberOfChannels; i++) {
                    let sample = Math.max(-1, Math.min(1, channels[i][offset] || 0));
                    view.setInt16(pos, sample * maxValue, true);
                    pos += 2;
                }
                offset++;
            }
            return new Blob([buffer], { type: 'audio/wav' });
        }

        async function performOpenAiTranscription() {
            const fileToTranscribe = processedFile || selectedFile;
            const formData = new FormData();
            formData.append('file', fileToTranscribe); formData.append('model', 'whisper-1'); formData.append('response_format', 'verbose_json');
            const response = await fetch('https://api.openai.com/v1/audio/transcriptions', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${elements.apiKey.value.trim()}` },
                body: formData
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error?.message || `HTTP ${response.status}`);
            return result;
        }

        async function performIvritAiTranscription() {
            showStatus('שולח משימה לשרת...');
            const fileToTranscribe = processedFile || selectedFile;
            const audio_base64 = await fileToBase64(fileToTranscribe);
            
            const startJobBody = JSON.stringify({
                input: {
                    transcribe_args: { 
                        blob: audio_base64, // Corrected from 'audio_base64' to 'blob'
                        language: "he" 
                    }
                }
            });

            const startResponse = await fetch(elements.proxyUrl.value.trim(), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-runpod-api-key': elements.runpodApiKey.value.trim(),
                    'x-runpod-endpoint-id': elements.endpointId.value.trim()
                },
                body: startJobBody
            });

            const startResult = await startResponse.json();
            if (!startResponse.ok || startResult.error) throw new Error(startResult.error?.message || startResult.error || `HTTP ${startResponse.status}`);
            if (!startResult.id) throw new Error("לא התקבל מזהה משימה מהשרת");

            const jobId = startResult.id;
            showStatus(`המשימה (${jobId.substring(0,8)}) נשלחה. ממתין לתוצאות...`);

            let pollCount = 0;
            const maxPolls = 60; // Poll for 5 minutes max (60 * 5s)
            while (pollCount < maxPolls) {
                await sleep(5000); 
                const statusResponse = await fetch(elements.proxyUrl.value.trim(), {
                    method: 'POST', 
                    headers: {
                        'x-runpod-api-key': elements.runpodApiKey.value.trim(),
                        'x-runpod-endpoint-id': elements.endpointId.value.trim(),
                        'x-job-id': jobId
                    }
                });

                const statusResult = await statusResponse.json();
                if (!statusResponse.ok) throw new Error(statusResult.error?.message || `HTTP ${statusResponse.status}`);
                if (statusResult.error) throw new Error(statusResult.error);
                
                if (statusResult.status === "COMPLETED") {
                    console.log("Full response from RunPod:", statusResult); // Log the full response for debugging
                    return statusResult.output;
                } else if (statusResult.status === "FAILED") {
                    throw new Error("התמלול נכשל בשרת");
                }
                pollCount++;
                showStatus(`בודק סטטוס... (${pollCount}/${maxPolls})`);
            }
            throw new Error("התמלול ארך זמן רב מדי");
        }
        
        function displayResults(resultData) {
            transcriptResult = resultData; // Set global variable
            console.log("Data passed to displayResults:", transcriptResult); // Log the data being displayed

            // Intelligent check for transcription text format
            let segments = null;
            if (transcriptResult && transcriptResult.segments) {
                segments = transcriptResult.segments;
            } else if (transcriptResult && Array.isArray(transcriptResult)) {
                // Handle cases where the output might be the segments array directly
                segments = transcriptResult;
            }

            if (!segments) {
                // Fallback if segments are not found, maybe the text is in a 'text' property or is the result itself
                const fallbackText = transcriptResult?.text || (typeof transcriptResult === 'string' ? transcriptResult : "לא נמצא טקסט תמלול בתוצאה.");
                elements.transcriptText.textContent = fallbackText;
                elements.resultArea.style.display = 'block';
                elements.resultArea.scrollIntoView({ behavior: 'smooth' });
                return;
            }

            const showTimestamps = elements.timestampToggle.classList.contains('active');
            const showParagraphs = elements.paragraphToggle.classList.contains('active');
            const separator = showParagraphs ? '\n\n' : ' ';
            let finalResult = segments.map(segment => {
                let line = segment.text.trim();
                if (showTimestamps) line = `[${formatVttTime(segment.start).substring(0, 8)}] ${line}`;
                return line;
            }).join(separator);

            elements.transcriptText.textContent = finalResult;
            elements.resultArea.style.display = 'block';
            elements.resultArea.scrollIntoView({ behavior: 'smooth' });
        }

        function generateVTTContent() {
            if (!transcriptResult || !transcriptResult.segments) return '';
            let vttContent = "WEBVTT\n\n";
            transcriptResult.segments.forEach(segment => {
                vttContent += `${formatVttTime(segment.start)} --> ${formatVttTime(segment.end)}\n${segment.text.trim()}\n\n`;
            });
            return vttContent;
        }
        
        function downloadHandler(isVTT) {
             const textToDownload = isVTT ? generateVTTContent() : elements.transcriptText.textContent;
             const blob = new Blob([textToDownload], { type: `${isVTT ? 'text/vtt' : 'text/plain'};charset=utf-8` });
             const a = document.createElement('a');
             a.href = URL.createObjectURL(blob);
             a.download = `transcript_${Date.now()}${isVTT ? '.vtt' : '.txt'}`;
             a.click();
             URL.revokeObjectURL(a.href);
        }

        function setupEventListeners() {
            elements.serviceSelector.addEventListener('change', (e) => {
                const is_openai = e.target.value === 'openai';
                elements.openaiSettings.classList.toggle('hidden', !is_openai);
                elements.ivritaiSettings.classList.toggle('hidden', is_openai);
                storage.save('serviceSelector', e.target.value);
                checkButtonsState();
            });
            
            ['apiKey', 'proxyUrl', 'endpointId', 'runpodApiKey'].forEach(id => {
                elements[id].addEventListener('input', checkButtonsState);
                elements[id].addEventListener('blur', (e) => storage.save(id, e.target.value));
            });

            elements.uploadArea.addEventListener('click', () => elements.fileInput.click());
            elements.fileInput.addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    selectedFile = e.target.files[0];
                    processedFile = null;
                    elements.fileName.textContent = selectedFile.name;
                    elements.fileSize.textContent = `(${(selectedFile.size / 1024 / 1024).toFixed(2)} MB)`;
                    elements.fileInfo.style.display = 'block';
                    elements.audioPreview.style.display = 'block';
                    elements.audioPlayer.src = URL.createObjectURL(selectedFile);
                    initAudioContext();
                    drawWaveform(selectedFile);
                    checkButtonsState();
                }
            });
            
            elements.processButton.addEventListener('click', async () => {
                if (!selectedFile) return;
                elements.processButton.disabled = true;
                elements.processButton.textContent = 'מעבד...';
                try {
                    initAudioContext();
                    processedFile = await processAudio(selectedFile);
                    elements.audioPlayer.src = URL.createObjectURL(processedFile);
                    elements.fileName.textContent = selectedFile.name + ' (מעובד)';
                    drawWaveform(processedFile);
                    elements.processButton.textContent = 'עובד ✓';
                } catch (error) {
                    alert('שגיאה בעיבוד האודיו: ' + error.message);
                    elements.processButton.textContent = 'שגיאה';
                } finally {
                    elements.processButton.disabled = false;
                }
            });

            elements.transcribeButton.addEventListener('click', async () => {
                elements.transcribeButton.disabled = true;
                elements.loadingSpinner.style.display = 'block';
                elements.resultArea.style.display = 'none';
                try {
                    showStatus('נשלח לתמלול...');
                    const service = elements.serviceSelector.value;
                    const resultData = service === 'openai' ? await performOpenAiTranscription() : await performIvritAiTranscription();
                    displayResults(resultData); // Pass the result directly
                    showStatus('התמלול הושלם בהצלחה! ✅', 'success');
                } catch (error) {
                    console.error('Transcription error:', error);
                    showStatus('שגיאה: ' + error.message, 'error');
                } finally {
                    elements.transcribeButton.disabled = false;
                    elements.loadingSpinner.style.display = 'none';
                }
            });
            
            document.querySelectorAll('.toggle').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    toggle.classList.toggle('active');
                    if (transcriptResult) displayResults(transcriptResult);
                });
            });
            
            elements.downloadTxtButton.addEventListener('click', () => downloadHandler(false));
            elements.downloadVttButton.addEventListener('click', () => downloadHandler(true));
            elements.copyButton.addEventListener('click', () => navigator.clipboard.writeText(elements.transcriptText.textContent));
            elements.resetButton.addEventListener('click', resetApp);
        }

        function initApp() {
            ['apiKey', 'proxyUrl', 'endpointId', 'runpodApiKey', 'serviceSelector'].forEach(id => {
                const savedValue = storage.load(id);
                if (savedValue && elements[id]) elements[id].value = savedValue;
            });
            elements.serviceSelector.dispatchEvent(new Event('change'));
            setupEventListeners();
            checkButtonsState();
            console.log('App loaded successfully! 🚀');
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
