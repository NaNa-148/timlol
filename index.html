<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>תמלול עברית AI - Hebrew Audio Transcription</title>
    <meta name="description" content="תמלול אודיו לטקסט בעברית באמצעות בינה מלאכותית">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            max-width: 900px;
            width: 100%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .title {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .info-box {
            background: rgba(40, 167, 69, 0.1);
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .info-text {
            color: #155724;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .info-subtext {
            color: #155724;
            font-size: 0.9rem;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
            background: rgba(102, 126, 234, 0.05);
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: rgba(118, 75, 162, 0.1);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: rgba(118, 75, 162, 0.15);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4rem;
            color: #667eea;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.3rem;
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .upload-subtext {
            color: #666;
            font-size: 0.95rem;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .options {
            background: rgba(102, 126, 234, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .option-group {
            margin-bottom: 20px;
        }

        .option-label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            color: #333;
            font-size: 1.1rem;
        }

        .api-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 15px;
            transition: border-color 0.3s ease;
        }

        .api-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .option-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .toggle {
            position: relative;
            width: 50px;
            height: 25px;
            background: #ddd;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle.active {
            background: #667eea;
        }

        .toggle::after {
            content: '';
            position: absolute;
            width: 21px;
            height: 21px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .toggle.active::after {
            transform: translateX(25px);
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .slider:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .slider:disabled:hover {
            opacity: 0.4;
        }

        .slider-container.disabled {
            opacity: 0.6;
        }

        .slider-container.disabled span {
            color: #999;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }

        .slider-value {
            min-width: 40px;
            font-weight: 600;
            color: #667eea;
        }

        .file-info {
            background: rgba(40, 167, 69, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
            border-right: 4px solid #28a745;
        }

        .file-name {
            font-weight: 600;
            color: #28a745;
            margin-bottom: 5px;
        }

        .file-size {
            color: #666;
            font-size: 0.9rem;
        }

        .audio-preview {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            display: none;
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .audio-player {
            flex: 1;
            height: 40px;
        }

        .canvas-container {
            margin: 15px 0;
            text-align: center;
        }

        .waveform-canvas {
            width: 100%;
            max-width: 600px;
            height: 100px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .button {
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .select-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1rem;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .select-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .process-button {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            padding: 8px 16px;
            font-size: 1rem;
        }

        .process-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
        }

        .transcribe-button {
            width: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 18px;
            border-radius: 15px;
            font-size: 1.3rem;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            margin-bottom: 30px;
        }

        .transcribe-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
        }

        .transcribe-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .download-button {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 10px 20px;
        }

        .download-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .result-area {
            background: white;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #f0f0f0;
            margin-top: 20px;
            display: none;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            flex-wrap: wrap;
            gap: 10px;
        }

        .result-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }
        
        .result-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .transcript-text {
            font-size: 1.1rem;
            line-height: 1.8;
            color: #333;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-right: 4px solid #667eea;
            min-height: 200px;
            white-space: pre-wrap;
            font-family: 'Arial', sans-serif;
        }

        .status {
            text-align: center;
            margin: 20px 0;
            font-weight: 600;
            display: none;
        }

        .status.processing {
            color: #667eea;
        }

        .status.success {
            color: #28a745;
        }

        .status.error {
            color: #dc3545;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-details {
            background: #fee;
            border: 1px solid #fcc;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-size: 0.9rem;
            color: #800;
            direction: ltr;
            text-align: left;
        }

        .reset-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: underline;
            padding: 5px;
            font-family: inherit;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .title {
                font-size: 2rem;
            }
            
            .upload-area {
                padding: 40px 15px;
            }
            
            .option-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .audio-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">תמלול עברית AI</h1>
            <p class="subtitle">המר אודיו לטקסט בעברית באמצעות בינה מלאכותית מתקדמת</p>
        </div>

        <div class="info-box">
            <div class="info-text">מוכן לשימוש! 🚀</div>
            <div class="info-subtext">הזן את מפתח OpenAI API שלך למטה והתחל לתמלל</div>
        </div>

        <div class="options">
            <div class="option-group">
                <label class="option-label">🔑 מפתח OpenAI API</label>
                <input type="password" id="apiKey" class="api-input" placeholder="sk-proj-..." 
                       autocomplete="off" spellcheck="false">
                <small style="color: #666;">המפתח נשמר בזיכרון הדפדפן ולא נשלח לאף מקום אחר</small>
            </div>

            <div class="option-group">
                <label class="option-label">🌍 שפת תמלול</label>
                <select id="languageSelect" class="api-input" style="padding: 12px;">
                    <option value="auto">זיהוי אוטומטי</option>
                    <option value="he" selected>עברית</option>
                    <option value="en">English</option>
                    <option value="ar">العربية</option>
                    <option value="ru">Русский</option>
                    <option value="es">Español</option>
                    <option value="fr">Français</option>
                    <option value="de">Deutsch</option>
                    <option value="it">Italiano</option>
                    <option value="pt">Português</option>
                    <option value="zh">中文</option>
                    <option value="ja">日本語</option>
                    <option value="ko">한국어</option>
                    <option value="hi">हिन्दी</option>
                    <option value="tr">Türkçe</option>
                    <option value="pl">Polski</option>
                    <option value="nl">Nederlands</option>
                    <option value="sv">Svenska</option>
                    <option value="da">Dansk</option>
                    <option value="no">Norsk</option>
                    <option value="fi">Suomi</option>
                </select>
            </div>
        </div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">🎤</div>
            <div class="upload-text">גרור קובץ אודיו לכאן או לחץ לבחירה</div>
            <div class="upload-subtext">תומך ב-MP3, WAV, M4A, MP4, WEBM, FLAC (עד 25MB)</div>
            <button class="button select-button" onclick="document.getElementById('fileInput').click();">בחר קובץ</button>
            <input type="file" id="fileInput" class="file-input" accept="audio/*,video/*">
        </div>

        <div class="file-info" id="fileInfo">
            <div class="file-name" id="fileName"></div>
            <div class="file-size" id="fileSize"></div>
        </div>

        <div class="audio-preview" id="audioPreview">
            <div class="audio-controls">
                <audio controls class="audio-player" id="audioPlayer"></audio>
            </div>
            <div class="canvas-container">
                <canvas class="waveform-canvas" id="waveformCanvas" width="600" height="100"></canvas>
            </div>
        </div>

        <div class="options">
            <div class="option-group">
                <label class="option-label">🔧 הגדרות עיבוד אודיו</label>
                
                <div class="option-row">
                    <span>הפעל מסנן רעשים</span>
                    <div class="toggle active" id="noiseReductionToggle"></div>
                </div>
                
                <div class="slider-container" id="noiseSliderContainer">
                    <span>רמת מסנן רעשים:</span>
                    <input type="range" class="slider" id="noiseReductionLevel" min="0" max="100" value="30">
                    <span class="slider-value" id="noiseReductionValue">30%</span>
                </div>
                
                <div class="option-row">
                    <span>נרמול עוצמת קול</span>
                    <div class="toggle active" id="normalizeToggle"></div>
                </div>
                
                <div class="slider-container" id="volumeSliderContainer">
                    <span>עוצמת קול יעד:</span>
                    <input type="range" class="slider" id="volumeLevel" min="50" max="150" value="100">
                    <span class="slider-value" id="volumeValue">100%</span>
                </div>

                <button class="button process-button" id="processButton" disabled style="width: 100%; margin-top: 15px; padding: 12px;">עבד אודיו</button>
            </div>

            <div class="option-group">
                <label class="option-label">📝 הגדרות תמלול</label>
                
                <div class="option-row">
                    <span>זיהוי משתתפים</span>
                    <div class="toggle" id="speakerToggle"></div>
                </div>
                
                <div class="option-row">
                    <span>חותמות זמן</span>
                    <div class="toggle active" id="timestampToggle"></div>
                </div>
            </div>
        </div>

        <button class="button transcribe-button" id="transcribeButton" disabled>התחל תמלול</button>

        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="loading-spinner" id="loadingSpinner"></div>
        <div class="status" id="status"></div>

        <div class="result-area" id="resultArea">
            <div class="result-header">
                <div class="result-title">תוצאת התמלול</div>
                <div class="result-actions">
                    <select id="improveModelSelect" class="api-input" style="width: auto; margin-bottom: 0;">
                        <option value="gpt-4o" selected>GPT-4o</option>
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                    </select>
                    <button class="button process-button" id="improveButton" style="display: none;">🔧 תיקון אוטומטי</button>
                    <button class="button download-button" id="downloadButton">הורד כ-TXT</button>
                </div>
            </div>
            <div class="transcript-text" id="transcriptText" contenteditable="true"></div>
            <div class="transcript-text" id="improvedText" contenteditable="true" style="display: none; margin-top: 15px; border-right-color: #28a745;">
                <div style="font-weight: bold; margin-bottom: 10px; color: #28a745;">✨ טקסט מתוקן:</div>
            </div>
        </div>

        <button id="resetButton" class="reset-button">איפוס מלא</button>
    </div>

    <script>
        // Global state
        let selectedFile = null;
        let processedFile = null;
        let transcriptResult = '';
        let improvedResult = '';
        let audioContext = null;
        let progressInterval = null;

        // DOM Elements
        const elements = {
            uploadArea: document.getElementById('uploadArea'),
            fileInput: document.getElementById('fileInput'),
            fileInfo: document.getElementById('fileInfo'),
            fileName: document.getElementById('fileName'),
            fileSize: document.getElementById('fileSize'),
            audioPreview: document.getElementById('audioPreview'),
            audioPlayer: document.getElementById('audioPlayer'),
            processButton: document.getElementById('processButton'),
            waveformCanvas: document.getElementById('waveformCanvas'),
            transcribeButton: document.getElementById('transcribeButton'),
            progressBar: document.getElementById('progressBar'),
            progressFill: document.getElementById('progressFill'),
            loadingSpinner: document.getElementById('loadingSpinner'),
            status: document.getElementById('status'),
            resultArea: document.getElementById('resultArea'),
            transcriptText: document.getElementById('transcriptText'),
            improvedText: document.getElementById('improvedText'),
            improveButton: document.getElementById('improveButton'),
            improveModelSelect: document.getElementById('improveModelSelect'),
            downloadButton: document.getElementById('downloadButton'),
            languageSelect: document.getElementById('languageSelect'),
            resetButton: document.getElementById('resetButton'),
            apiKey: document.getElementById('apiKey'),
            noiseReductionToggle: document.getElementById('noiseReductionToggle'),
            noiseSliderContainer: document.getElementById('noiseSliderContainer'),
            noiseReductionLevel: document.getElementById('noiseReductionLevel'),
            noiseReductionValue: document.getElementById('noiseReductionValue'),
            normalizeToggle: document.getElementById('normalizeToggle'),
            volumeSliderContainer: document.getElementById('volumeSliderContainer'),
            volumeLevel: document.getElementById('volumeLevel'),
            volumeValue: document.getElementById('volumeValue'),
            speakerToggle: document.getElementById('speakerToggle'),
            timestampToggle: document.getElementById('timestampToggle')
        };

        // --- LOCAL STORAGE ---
        const storage = {
            saveApiKey(key) {
                if (key?.trim()) {
                    try {
                        localStorage.setItem('hebrew_transcription_api_key', key.trim());
                    } catch (error) {
                        console.warn('Could not save API key:', error);
                    }
                }
            },
            loadApiKey() {
                try {
                    const saved = localStorage.getItem('hebrew_transcription_api_key');
                    if (saved?.trim()) {
                        elements.apiKey.value = saved.trim();
                        return true;
                    }
                } catch (error) {
                    console.warn('Could not load API key:', error);
                }
                return false;
            }
        };

        // --- UI & HELPERS ---
        function checkButtonsState() {
            const apiKey = elements.apiKey.value.trim();
            const hasFile = selectedFile || processedFile;
            elements.transcribeButton.disabled = !apiKey || !hasFile;
            elements.processButton.disabled = !selectedFile;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showStatus(message, type = 'processing') {
            elements.status.className = `status ${type}`;
            elements.status.textContent = message;
            elements.status.style.display = 'block';
        }

        function hideStatus() {
            elements.status.style.display = 'none';
        }
        
        function setButtonState(button, text, state = 'default') {
            button.disabled = state === 'loading';
            button.textContent = text;
            
            const stateColors = {
                default: '',
                success: 'linear-gradient(135deg, #28a745, #20c997)',
                error: 'linear-gradient(135deg, #dc3545, #c82333)'
            };
            
            button.style.background = stateColors[state] || '';
        }

        function simulateProgress(start, end, duration) {
            if (progressInterval) clearInterval(progressInterval);
            
            let current = start;
            elements.progressFill.style.width = `${start}%`;
            
            const stepTime = 50;
            const steps = duration / stepTime;
            const increment = (end - start) / steps;

            progressInterval = setInterval(() => {
                current += increment;
                if (current >= end) {
                    current = end;
                    clearInterval(progressInterval);
                }
                elements.progressFill.style.width = `${current}%`;
            }, stepTime);
        }

        function finalizeProgress() {
            if (progressInterval) clearInterval(progressInterval);
            elements.progressFill.style.width = `100%`;
            setTimeout(() => {
                elements.progressBar.style.display = 'none';
                elements.progressFill.style.width = `0%`;
            }, 500);
        }

        // --- FILE HANDLING ---
        function handleFileSelect(file) {
            if (!file) return;
            
            selectedFile = file;
            processedFile = null;
            
            try {
                elements.fileName.textContent = file.name;
                elements.fileSize.textContent = formatFileSize(file.size);
                elements.fileInfo.style.display = 'block';
                elements.audioPreview.style.display = 'block';
                elements.resultArea.style.display = 'none';
                
                setButtonState(elements.processButton, 'עבד אודיו', 'default');
                
                const url = URL.createObjectURL(file);
                elements.audioPlayer.src = url;
                
                drawWaveform(file);
                checkButtonsState();
                
                if (file.size > 25 * 1024 * 1024) {
                    const sizeMB = (file.size / 1024 / 1024).toFixed(1);
                    alert(`⚠️ הקובץ גדול (${sizeMB}MB) מהמגבלה של OpenAI (25MB).\n\nהמערכת תדחוס אותו אוטומטית בעיבוד האודיו.`);
                }
                
            } catch (error) {
                console.error('Error in handleFileSelect:', error);
                alert('שגיאה בטעינת הקובץ: ' + error.message);
            }
        }

        // --- AUDIO PROCESSING & WAVEFORM ---
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function drawWaveform(file) {
            const canvas = elements.waveformCanvas;
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#667eea';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('טוען צורת גל...', canvas.width / 2, canvas.height / 2);
            
            file.arrayBuffer().then(arrayBuffer => {
                if (audioContext) {
                    return audioContext.decodeAudioData(arrayBuffer);
                }
                return Promise.reject('No audio context');
            }).then(audioBuffer => {
                drawAudioWaveform(ctx, canvas, audioBuffer);
            }).catch(error => {
                console.warn('Could not draw waveform:', error);
                drawSimpleWaveform(ctx, canvas);
            });
        }

        function drawSimpleWaveform(ctx, canvas) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            const centerY = canvas.height / 2;
            for (let x = 0; x < canvas.width; x += 2) {
                const amplitude = Math.sin(x * 0.02) * Math.random() * 20;
                ctx.lineTo(x, centerY + amplitude);
            }
            ctx.stroke();
        }

        function drawAudioWaveform(ctx, canvas, audioBuffer) {
            const data = audioBuffer.getChannelData(0);
            const step = Math.ceil(data.length / canvas.width);
            const amp = canvas.height / 2;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 1;
            ctx.beginPath();
            
            for (let i = 0; i < canvas.width; i++) {
                let min = 1.0;
                let max = -1.0;
                
                for (let j = 0; j < step; j++) {
                    const datum = data[(i * step) + j];
                    if (datum < min) min = datum;
                    if (datum > max) max = datum;
                }
                
                ctx.moveTo(i, (1 + min) * amp);
                ctx.lineTo(i, (1 + max) * amp);
            }
            ctx.stroke();
        }

        async function processAudio(file) {
            const arrayBuffer = await file.arrayBuffer();
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
            
            const offlineContext = new OfflineAudioContext(
                audioBuffer.numberOfChannels,
                audioBuffer.length,
                audioBuffer.sampleRate
            );
            
            const source = offlineContext.createBufferSource();
            source.buffer = audioBuffer;
            let currentNode = source;
            
            // Apply noise reduction
            if (elements.noiseReductionToggle.classList.contains('active')) {
                const noiseReduction = offlineContext.createBiquadFilter();
                noiseReduction.type = 'highpass';
                noiseReduction.frequency.value = Math.min(200 + (elements.noiseReductionLevel.value * 3), 800);
                noiseReduction.Q.value = 1;
                currentNode.connect(noiseReduction);
                currentNode = noiseReduction;
            }
            
            // Apply normalization (compressor)
            if (elements.normalizeToggle.classList.contains('active')) {
                const compressor = offlineContext.createDynamicsCompressor();
                compressor.threshold.value = -24;
                compressor.knee.value = 30;
                compressor.ratio.value = 12;
                compressor.attack.value = 0.003;
                compressor.release.value = 0.25;
                
                currentNode.connect(compressor);
                currentNode = compressor;
            }
            
            // Apply volume adjustment
            const volumeLevel = elements.volumeLevel.value / 100;
            if (volumeLevel !== 1) {
                const gainNode = offlineContext.createGain();
                gainNode.gain.value = volumeLevel;
                currentNode.connect(gainNode);
                currentNode = gainNode;
            }
            
            currentNode.connect(offlineContext.destination);
            source.start();
            const processedBuffer = await offlineContext.startRendering();
            
            return bufferToWaveFile(processedBuffer);
        }

        function bufferToWaveFile(audioBuffer, targetBitRate = 128) {
            const [numberOfChannels, sampleRate] = [audioBuffer.numberOfChannels, audioBuffer.sampleRate];
            const bitsPerSample = 16;
            const bytesPerSample = bitsPerSample / 8;
            const length = audioBuffer.length * numberOfChannels * bytesPerSample + 44;
            const buffer = new ArrayBuffer(length);
            const view = new DataView(buffer);
            let pos = 0;

            const writeString = (str) => {
                for (let i = 0; i < str.length; i++) view.setUint8(pos + i, str.charCodeAt(i));
                pos += str.length;
            };
            const writeUint32 = (data) => { view.setUint32(pos, data, true); pos += 4; };
            const writeUint16 = (data) => { view.setUint16(pos, data, true); pos += 2; };

            writeString('RIFF');
            writeUint32(length - 8);
            writeString('WAVE');
            writeString('fmt ');
            writeUint32(16);
            writeUint16(1);
            writeUint16(numberOfChannels);
            writeUint32(sampleRate);
            writeUint32(sampleRate * numberOfChannels * bytesPerSample);
            writeUint16(numberOfChannels * bytesPerSample);
            writeUint16(bitsPerSample);
            writeString('data');
            writeUint32(length - pos - 4);

            const channels = Array.from({ length: numberOfChannels }, (_, i) => audioBuffer.getChannelData(i));
            let offset = 0;
            const maxValue = 32767;

            while (pos < length) {
                for (let i = 0; i < numberOfChannels; i++) {
                    let sample = Math.max(-1, Math.min(1, channels[i][offset] || 0));
                    view.setInt16(pos, sample * maxValue, true);
                    pos += 2;
                }
                offset++;
            }
            return new Blob([buffer], { type: 'audio/wav' });
        }

        // --- OPENAI API ---
        async function performTranscription(file, apiKey) {
            showStatus('מעבד קובץ אודיו...');
            if (file.size > 25 * 1024 * 1024) throw new Error('קובץ גדול מדי. הגודל המקסימלי הוא 25MB');
            
            let fileToSend = file;
            if (file instanceof Blob && !file.name) {
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const originalName = selectedFile ? selectedFile.name.replace(/\.[^/.]+$/, "") : "processed";
                fileToSend = new File([file], `${originalName}_processed_${timestamp}.wav`, { type: 'audio/wav' });
            }

            const formData = new FormData();
            formData.append('file', fileToSend);
            formData.append('model', 'whisper-1');
            const selectedLanguage = elements.languageSelect.value;
            if (selectedLanguage !== 'auto') formData.append('language', selectedLanguage);
            formData.append('response_format', 'json');

            showStatus('נשלח לתמלול...');
            simulateProgress(5, 90, 45000); // Simulate progress over 45 seconds
            
            const response = await fetch('https://api.openai.com/v1/audio/transcriptions', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${apiKey}` },
                body: formData
            });

            const result = await response.json();

            if (!response.ok) {
                let errorMessage = result.error?.message || `HTTP ${response.status}`;
                if (errorMessage.includes('rate limit')) errorMessage = 'חרגת ממגבלת הקריאות. המתן מספר דקות ונסה שוב';
                else if (errorMessage.includes('quota') || errorMessage.includes('credit')) errorMessage = 'חרגת ממכסת הקרדיט או אין אשראי בחשבון OpenAI';
                else if (errorMessage.includes('invalid api key') || errorMessage.includes('authentication')) errorMessage = 'מפתח API לא תקין. בדוק את המפתח בפלטפורמת OpenAI';
                else if (errorMessage.includes('audio file is invalid') || errorMessage.includes('unsupported')) errorMessage = 'קובץ האודיו לא נתמך או פגום. נסה להמיר ל-MP3 או WAV';
                throw new Error(errorMessage);
            }
            
            if (!result.text || result.text.trim() === '') {
                throw new Error('לא זוהה טקסט בקובץ האודיו. ייתכן שהקול לא ברור או שהקובץ ריק');
            }

            transcriptResult = result.text.trim();
            displayResults();
        }
        
        async function improveText(text, apiKey) {
            const selectedModel = elements.improveModelSelect.value;
            
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: selectedModel,
                    messages: [{
                        role: 'system',
                        content: 'אתה עורך טקסט מקצועי בעברית. המשימה שלך היא לתקן שגיאות דקדוק, כתיב, פיסוק ולהשלים מילים חסרות בטקסט שקיבלת מתמלול אודיו. שמור על המשמעות המקורית והתוכן, רק תקן שגיאות ותשפר את הקריאות. תקן גם מילים שנשמעו לא נכון או לא מובנות.'
                    }, {
                        role: 'user',
                        content: `אנא תקן ותשפר את הטקסט הבא מתמלול אודיו:\n\n${text}`
                    }],
                    max_tokens: 4000,
                    temperature: 0.2
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error?.message || `HTTP ${response.status}`);
            }

            const result = await response.json();
            const improvedContent = result.choices[0]?.message?.content?.trim();
            
            if (!improvedContent || improvedContent === text) {
                throw new Error('לא ניתן לשפר את הטקסט או שהוא כבר מושלם');
            }
            
            return improvedContent;
        }

        function displayResults() {
            let finalResult = transcriptResult;

            if (elements.timestampToggle.classList.contains('active')) {
                const sentences = finalResult.split(/[.!?]+/).filter(s => s.trim().length > 0);
                finalResult = sentences.map((sentence, index) => {
                    const minutes = Math.floor(index * 10 / 60);
                    const seconds = (index * 10) % 60;
                    const timestamp = `[${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}]`;
                    return `${timestamp} ${sentence.trim()}`;
                }).join('. ') + '.';
            }

            if (elements.speakerToggle.classList.contains('active')) {
                finalResult = 'משתתף 1: ' + finalResult;
            }

            elements.transcriptText.textContent = finalResult;
            elements.resultArea.style.display = 'block';
            elements.improveButton.style.display = 'inline-block';
            elements.improvedText.style.display = 'none';
            
            showStatus('התמלול הושלם בהצלחה! ✅', 'success');
            elements.resultArea.scrollIntoView({ behavior: 'smooth' });
            
            setTimeout(hideStatus, 5000);
        }

        // --- APP RESET & INITIALIZATION ---
        function resetSettingsToDefault() {
            // Language
            elements.languageSelect.value = 'he';
            
            // Audio processing toggles and sliders
            elements.noiseReductionToggle.classList.add('active');
            elements.noiseReductionLevel.value = 30;
            elements.noiseReductionValue.textContent = '30%';
            elements.noiseReductionLevel.disabled = false;
            elements.noiseSliderContainer.classList.remove('disabled');

            elements.normalizeToggle.classList.add('active');
            elements.volumeLevel.value = 100;
            elements.volumeValue.textContent = '100%';
            elements.volumeLevel.disabled = false;
            elements.volumeSliderContainer.classList.remove('disabled');
            
            // Transcription toggles
            elements.speakerToggle.classList.remove('active');
            elements.timestampToggle.classList.add('active');

            // Text improvement model
            elements.improveModelSelect.value = 'gpt-4o';
        }
        
        function resetApp() {
            if (confirm('האם אתה בטוח שברצונך לאפס את האפליקציה?\n\nכל הקבצים, התמלולים וההגדרות יחזרו למצב ברירת המחדל.')) {
                selectedFile = null;
                processedFile = null;
                transcriptResult = '';
                improvedResult = '';
                
                elements.fileInfo.style.display = 'none';
                elements.audioPreview.style.display = 'none';
                elements.resultArea.style.display = 'none';
                elements.progressBar.style.display = 'none';
                elements.loadingSpinner.style.display = 'none';
                elements.improvedText.style.display = 'none';
                elements.improveButton.style.display = 'none';
                hideStatus();
                
                elements.audioPlayer.src = '';
                setButtonState(elements.processButton, 'עבד אודיו');
                setButtonState(elements.improveButton, '🔧 תיקון אוטומטי');
                
                const ctx = elements.waveformCanvas.getContext('2d');
                ctx.clearRect(0, 0, elements.waveformCanvas.width, elements.waveformCanvas.height);
                
                elements.fileInput.value = '';
                elements.transcriptText.textContent = '';
                elements.improvedText.innerHTML = '<div style="font-weight: bold; margin-bottom: 10px; color: #28a745;">✨ טקסט מתוקן:</div>';
                
                resetSettingsToDefault();
                checkButtonsState();
                console.log('System reset completed');
            }
        }

        // --- EVENT LISTENERS SETUP ---
        function setupEventListeners() {
            elements.apiKey.addEventListener('input', (e) => {
                const key = e.target.value.trim();
                if (key && key.length > 10) storage.saveApiKey(key);
                checkButtonsState();
            });

            elements.apiKey.addEventListener('blur', (e) => {
                const key = e.target.value.trim();
                if (key) storage.saveApiKey(key);
            });

            elements.processButton.addEventListener('click', async () => {
                if (!selectedFile) return;
                
                setButtonState(elements.processButton, 'מעבד...', 'loading');
                
                try {
                    if (!audioContext) initAudioContext();
                    if (audioContext.state === 'suspended') await audioContext.resume();
                    
                    processedFile = await processAudio(selectedFile);
                    
                    elements.audioPlayer.src = URL.createObjectURL(processedFile);
                    setButtonState(elements.processButton, 'עובד ✓', 'success');
                    elements.fileName.textContent = selectedFile.name + ' (מעובד)';
                    elements.fileSize.textContent = formatFileSize(processedFile.size);
                    
                    drawWaveform(processedFile);
                    checkButtonsState();
                    
                } catch (error) {
                    console.error('Audio processing error:', error);
                    setButtonState(elements.processButton, 'שגיאה בעיבוד', 'error');
                    alert('שגיאה בעיבוד האודיו: ' + error.message + '\n\nנסה קובץ אחר או התמלל בלי עיבוד.');
                }
                
                setTimeout(() => {
                    elements.processButton.disabled = false;
                    if (elements.processButton.textContent !== 'עובד ✓') {
                        setButtonState(elements.processButton, 'עבד אודיו', 'default');
                    }
                }, 3000);
            });

            elements.transcribeButton.addEventListener('click', async () => {
                const fileToTranscribe = processedFile || selectedFile;
                const apiKey = elements.apiKey.value.trim();
                
                if (!fileToTranscribe || !apiKey) {
                    alert('אנא בחר קובץ והזן מפתח API');
                    return;
                }

                elements.transcribeButton.disabled = true;
                elements.progressBar.style.display = 'block';
                elements.loadingSpinner.style.display = 'block';
                elements.resultArea.style.display = 'none';
                
                try {
                    await performTranscription(fileToTranscribe, apiKey);
                } catch (error) {
                    console.error('Transcription error:', error);
                    showStatus('שגיאה: ' + error.message, 'error');
                } finally {
                    elements.transcribeButton.disabled = false;
                    elements.loadingSpinner.style.display = 'none';
                    finalizeProgress();
                }
            });

            elements.improveButton.addEventListener('click', async () => {
                const apiKey = elements.apiKey.value.trim();
                if (!apiKey) {
                    alert('נדרש מפתח API לתיקון טקסט');
                    return;
                }

                setButtonState(elements.improveButton, '🔄 מתקן...', 'loading');

                try {
                    const improvedTranscript = await improveText(elements.transcriptText.textContent, apiKey);
                    improvedResult = improvedTranscript;
                    elements.improvedText.innerHTML = '<div style="font-weight: bold; margin-bottom: 10px; color: #28a745;">✨ טקסט מתוקן:</div>' + improvedTranscript;
                    elements.improvedText.style.display = 'block';
                    setButtonState(elements.improveButton, '✅ הושלם', 'success');
                } catch (error) {
                    console.error('Text improvement error:', error);
                    alert('שגיאה בתיקון הטקסט: ' + error.message);
                    setButtonState(elements.improveButton, '❌ שגיאה', 'error');
                }

                setTimeout(() => {
                    elements.improveButton.disabled = false;
                     if (elements.improveButton.textContent !== '✅ הושלם') {
                        setButtonState(elements.improveButton, '🔧 תיקון אוטומטי', 'default');
                    }
                }, 3000);
            });

            elements.downloadButton.addEventListener('click', () => {
                const hasImprovedText = elements.improvedText.style.display !== 'none' && improvedResult;
                const textToDownload = hasImprovedText ? improvedResult : elements.transcriptText.textContent;
                const filenameSuffix = hasImprovedText ? '_improved' : '';
                
                const blob = new Blob([textToDownload], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const originalName = selectedFile ? selectedFile.name.replace(/\.[^/.]+$/, "") : "transcript";
                a.download = `${originalName}_transcript${filenameSuffix}_${timestamp}.txt`;
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
            
            // File input listeners
            elements.uploadArea.addEventListener('click', () => elements.fileInput.click());
            elements.uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); elements.uploadArea.classList.add('dragover'); });
            elements.uploadArea.addEventListener('dragleave', () => elements.uploadArea.classList.remove('dragover'));
            elements.uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                elements.uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) handleFileSelect(e.dataTransfer.files[0]);
            });
            elements.fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                    setTimeout(() => e.target.value = '', 100);
                }
            });

            // Toggles
            document.querySelectorAll('.toggle').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    toggle.classList.toggle('active');
                    if (toggle.id === 'noiseReductionToggle') {
                        const isActive = toggle.classList.contains('active');
                        elements.noiseReductionLevel.disabled = !isActive;
                        elements.noiseSliderContainer.classList.toggle('disabled', !isActive);
                    }
                    if (toggle.id === 'normalizeToggle') {
                        const isActive = toggle.classList.contains('active');
                        elements.volumeLevel.disabled = !isActive;
                        elements.volumeSliderContainer.classList.toggle('disabled', !isActive);
                    }
                });
            });

            // Sliders
            elements.noiseReductionLevel.addEventListener('input', (e) => { elements.noiseReductionValue.textContent = e.target.value + '%'; });
            elements.volumeLevel.addEventListener('input', (e) => { elements.volumeValue.textContent = e.target.value + '%'; });
            
            elements.resetButton.addEventListener('click', resetApp);
        }

        // --- APP INITIALIZATION ---
        function initApp() {
            storage.loadApiKey();
            resetSettingsToDefault();
            setupEventListeners();
            checkButtonsState();
            
            document.body.addEventListener('click', () => {
                if (!audioContext) {
                    try { initAudioContext(); } catch (e) { console.warn('Could not init audio context', e); }
                }
            }, { once: true });
            
            console.log('Hebrew Transcription App loaded successfully! 🚀');
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
