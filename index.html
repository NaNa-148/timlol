<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>תמלול עברית AI - Hebrew Audio Transcription</title>
    <meta name="description" content="תמלול אודיו לטקסט בעברית באמצעות בינה מלאכותית">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', 'Arial', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; line-height: 1.6; }
        .container { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 40px; max-width: 900px; width: 100%; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); }
        .header { text-align: center; margin-bottom: 40px; }
        .title { font-size: 2.5rem; font-weight: 700; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; }
        .subtitle { color: #666; font-size: 1.1rem; margin-bottom: 20px; }
        .upload-area { border: 3px dashed #667eea; border-radius: 15px; padding: 60px 20px; text-align: center; margin-bottom: 30px; transition: all 0.3s ease; cursor: pointer; background: rgba(102, 126, 234, 0.05); }
        .upload-area:hover { border-color: #764ba2; background: rgba(118, 75, 162, 0.1); transform: translateY(-2px); }
        .file-input { display: none; }
        .options { background: rgba(102, 126, 234, 0.05); border-radius: 15px; padding: 25px; margin-bottom: 30px; }
        .option-group { margin-bottom: 20px; }
        .option-label { display: block; margin-bottom: 12px; font-weight: 600; color: #333; font-size: 1.1rem; }
        .api-input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; margin-bottom: 15px; transition: border-color 0.3s ease; }
        .api-input:focus { outline: none; border-color: #667eea; }
        .option-row { display: flex; align-items: center; gap: 15px; margin-bottom: 12px; flex-wrap: wrap; }
        .toggle { position: relative; width: 50px; height: 25px; background: #ddd; border-radius: 25px; cursor: pointer; transition: all 0.3s ease; }
        .toggle.active { background: #667eea; }
        .toggle::after { content: ''; position: absolute; width: 21px; height: 21px; border-radius: 50%; background: white; top: 2px; left: 2px; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); }
        .toggle.active::after { transform: translateX(25px); }
        .file-info { background: rgba(40, 167, 69, 0.1); border-radius: 10px; padding: 15px; margin-bottom: 20px; display: none; border-right: 4px solid #28a745; }
        .audio-preview { background: rgba(102, 126, 234, 0.1); border-radius: 10px; padding: 15px; margin: 15px 0; display: none; }
        .audio-player { width: 100%; height: 40px; }
        .button { border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-align: center; }
        .transcribe-button { width: 100%; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 18px; border-radius: 15px; font-size: 1.3rem; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3); margin-bottom: 30px; }
        .transcribe-button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .download-button { background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 10px 20px; }
        .download-button.vtt { background: linear-gradient(135deg, #fd7e14, #ffc107); }
        .copy-button { background: #f0f0f0; color: #333; padding: 10px 15px; font-size: 0.9rem; }
        .result-area { background: white; border-radius: 15px; padding: 25px; border: 2px solid #f0f0f0; margin-top: 20px; display: none; }
        .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0; flex-wrap: wrap; gap: 10px; }
        .result-title { font-size: 1.3rem; font-weight: 600; color: #333; }
        .result-actions { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .transcript-text { font-size: 1.1rem; line-height: 1.8; color: #333; background: #f8f9fa; padding: 20px; border-radius: 10px; border-right: 4px solid #667eea; min-height: 200px; white-space: pre-wrap; font-family: 'Arial', sans-serif; }
        .status { text-align: center; margin: 20px 0; font-weight: 600; display: none; }
        .loading-spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .reset-button { position: fixed; bottom: 20px; left: 20px; background: none; border: none; color: #666; cursor: pointer; font-size: 0.9rem; text-decoration: underline; padding: 5px; font-family: inherit; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">תמלול עברית AI</h1>
            <p class="subtitle">המר אודיו לטקסט בעברית באמצעות בינה מלאכותית מתקדמת</p>
        </div>

        <div class="options">
             <div class="option-group">
                <label class="option-label">⚙️ בחר שירות תמלול</label>
                <select id="serviceSelector" class="api-input">
                    <option value="openai" selected>OpenAI Whisper</option>
                    <option value="ivritai">Ivrit.ai (via RunPod)</option>
                </select>
            </div>
            
            <div id="openaiSettings">
                <div class="option-group">
                    <label class="option-label">🔑 מפתח OpenAI API</label>
                    <input type="password" id="apiKey" class="api-input" placeholder="sk-proj-...">
                </div>
            </div>

            <div id="ivritaiSettings" class="hidden">
                 <div class="option-group">
                    <label class="option-label">☁️ כתובת Cloudflare Proxy</label>
                    <input type="text" id="proxyUrl" class="api-input" placeholder="https://your-worker.username.workers.dev">
                </div>
                <div class="option-group">
                    <label class="option-label">🚀 מזהה RunPod Endpoint</label>
                    <input type="text" id="endpointId" class="api-input" placeholder="p8xJj85vV4i7y...">
                </div>
                 <div class="option-group">
                    <label class="option-label">🔑 מפתח RunPod API</label>
                    <input type="password" id="runpodApiKey" class="api-input" placeholder="ABCD123...">
                </div>
            </div>
        </div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">🎤</div>
            <div class="upload-text">גרור קובץ אודיו לכאן או לחץ לבחירה</div>
            <input type="file" id="fileInput" class="file-input" accept="audio/*,video/*">
        </div>

        <div class="file-info" id="fileInfo"></div>
        <div class="audio-preview" id="audioPreview">
            <audio controls class="audio-player" id="audioPlayer"></audio>
        </div>

        <div class="options">
             <div class="option-group">
                <label class="option-label">📝 הגדרות תצוגה</label>
                 <div class="option-row"><span>חותמות זמן</span><div class="toggle" id="timestampToggle"></div></div>
                <div class="option-row"><span>הצג כפסקאות</span><div class="toggle" id="paragraphToggle"></div></div>
            </div>
        </div>

        <button class="button transcribe-button" id="transcribeButton" disabled>התחל תמלול</button>
        <div class="loading-spinner" id="loadingSpinner"></div>
        <div class="status" id="status"></div>

        <div class="result-area" id="resultArea">
            <div class="result-header">
                <div class="result-title">תוצאת התמלול</div>
                <div class="result-actions">
                    <button class="button copy-button" id="copyButton">העתק הכל</button>
                    <button class="button download-button" id="downloadTxtButton">הורד כ-TXT</button>
                    <button class="button download-button vtt" id="downloadVttButton">הורד כ-VTT</button>
                </div>
            </div>
            <div class="transcript-text" id="transcriptText" contenteditable="true" style="margin-top: 15px;"></div>
        </div>

        <button id="resetButton" class="reset-button">איפוס</button>
    </div>

    <script>
        // Global state
        let selectedFile = null;
        let transcriptResult = null;

        // DOM Elements
        const elements = {
            serviceSelector: document.getElementById('serviceSelector'),
            openaiSettings: document.getElementById('openaiSettings'),
            ivritaiSettings: document.getElementById('ivritaiSettings'),
            apiKey: document.getElementById('apiKey'),
            proxyUrl: document.getElementById('proxyUrl'),
            endpointId: document.getElementById('endpointId'),
            runpodApiKey: document.getElementById('runpodApiKey'),
            uploadArea: document.getElementById('uploadArea'),
            fileInput: document.getElementById('fileInput'),
            fileInfo: document.getElementById('fileInfo'),
            audioPreview: document.getElementById('audioPreview'),
            audioPlayer: document.getElementById('audioPlayer'),
            transcribeButton: document.getElementById('transcribeButton'),
            loadingSpinner: document.getElementById('loadingSpinner'),
            status: document.getElementById('status'),
            resultArea: document.getElementById('resultArea'),
            transcriptText: document.getElementById('transcriptText'),
            downloadTxtButton: document.getElementById('downloadTxtButton'),
            downloadVttButton: document.getElementById('downloadVttButton'),
            copyButton: document.getElementById('copyButton'),
            resetButton: document.getElementById('resetButton'),
            timestampToggle: document.getElementById('timestampToggle'),
            paragraphToggle: document.getElementById('paragraphToggle'),
        };

        // --- LOCAL STORAGE ---
        const storage = {
            save(key, value) { try { localStorage.setItem(key, value); } catch (e) { console.warn(`Could not save ${key}`, e); } },
            load(key) { try { return localStorage.getItem(key) || ''; } catch (e) { console.warn(`Could not load ${key}`, e); return ''; } }
        };

        // --- HELPERS ---
        const fileToBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });
        const formatVttTime = (seconds) => new Date(seconds * 1000).toISOString().substr(11, 12);

        // --- UI & STATE MANAGEMENT ---
        function checkButtonsState() {
            const service = elements.serviceSelector.value;
            let hasCredentials = false;
            if (service === 'openai') {
                hasCredentials = !!elements.apiKey.value.trim();
            } else {
                hasCredentials = !!elements.proxyUrl.value.trim() && !!elements.endpointId.value.trim() && !!elements.runpodApiKey.value.trim();
            }
            elements.transcribeButton.disabled = !selectedFile || !hasCredentials;
        }

        function showStatus(message, type = 'processing') {
            elements.status.className = `status ${type}`;
            elements.status.textContent = message;
            elements.status.style.display = 'block';
        }
        
        function resetUI() {
            selectedFile = null;
            transcriptResult = null;
            elements.fileInfo.style.display = 'none';
            elements.audioPreview.style.display = 'none';
            elements.resultArea.style.display = 'none';
            elements.fileInput.value = '';
            checkButtonsState();
        }

        // --- TRANSCRIPTION LOGIC ---
        async function performOpenAiTranscription() {
            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('model', 'whisper-1');
            formData.append('response_format', 'verbose_json');
            const response = await fetch('https://api.openai.com/v1/audio/transcriptions', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${elements.apiKey.value.trim()}` },
                body: formData
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error?.message || `HTTP ${response.status}`);
            return result;
        }

        async function performIvritAiTranscription() {
            showStatus('ממיר קובץ לשליחה...');
            const audio_base64 = await fileToBase64(selectedFile);
            const body = JSON.stringify({ input: { audio_base64, language: "he" } });
            const response = await fetch(elements.proxyUrl.value.trim(), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-runpod-api-key': elements.runpodApiKey.value.trim(),
                    'x-runpod-endpoint-id': elements.endpointId.value.trim()
                },
                body
            });
            const result = await response.json();
            if (!response.ok || result.error) throw new Error(result.error || `HTTP ${response.status}`);
            if (result.output && result.output.segments) return result.output;
            throw new Error('תגובה לא תקינה מהשרת');
        }
        
        // --- DISPLAY & DOWNLOAD ---
        function displayResults() {
            if (!transcriptResult || !transcriptResult.segments) return;
            const showTimestamps = elements.timestampToggle.classList.contains('active');
            const showParagraphs = elements.paragraphToggle.classList.contains('active');
            const separator = showParagraphs ? '\n\n' : ' ';
            let finalResult = transcriptResult.segments.map(segment => {
                let line = segment.text.trim();
                if (showTimestamps) line = `[${formatVttTime(segment.start).substring(0, 8)}] ${line}`;
                return line;
            }).join(separator);
            elements.transcriptText.textContent = finalResult;
            elements.resultArea.style.display = 'block';
            elements.resultArea.scrollIntoView({ behavior: 'smooth' });
        }

        function generateVTTContent() {
            if (!transcriptResult || !transcriptResult.segments) return '';
            let vttContent = "WEBVTT\n\n";
            transcriptResult.segments.forEach(segment => {
                vttContent += `${formatVttTime(segment.start)} --> ${formatVttTime(segment.end)}\n${segment.text.trim()}\n\n`;
            });
            return vttContent;
        }
        
        function downloadHandler(isVTT) {
             const textToDownload = isVTT ? generateVTTContent() : elements.transcriptText.textContent;
             const blob = new Blob([textToDownload], { type: `${isVTT ? 'text/vtt' : 'text/plain'};charset=utf-8` });
             const a = document.createElement('a');
             a.href = URL.createObjectURL(blob);
             a.download = `transcript_${Date.now()}${isVTT ? '.vtt' : '.txt'}`;
             a.click();
             URL.revokeObjectURL(a.href);
        }

        // --- EVENT HANDLERS ---
        function setupEventListeners() {
            elements.serviceSelector.addEventListener('change', (e) => {
                const is_openai = e.target.value === 'openai';
                elements.openaiSettings.classList.toggle('hidden', !is_openai);
                elements.ivritaiSettings.classList.toggle('hidden', is_openai);
                storage.save('serviceSelector', e.target.value);
                checkButtonsState();
            });
            
            ['apiKey', 'proxyUrl', 'endpointId', 'runpodApiKey'].forEach(id => {
                elements[id].addEventListener('input', checkButtonsState);
                elements[id].addEventListener('blur', (e) => storage.save(id, e.target.value));
            });

            elements.uploadArea.addEventListener('click', () => elements.fileInput.click());
            elements.fileInput.addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    selectedFile = e.target.files[0];
                    elements.fileInfo.textContent = selectedFile.name;
                    elements.fileInfo.style.display = 'block';
                    elements.audioPreview.style.display = 'block';
                    elements.audioPlayer.src = URL.createObjectURL(selectedFile);
                    checkButtonsState();
                }
            });

            elements.transcribeButton.addEventListener('click', async () => {
                elements.transcribeButton.disabled = true;
                elements.loadingSpinner.style.display = 'block';
                elements.resultArea.style.display = 'none';
                try {
                    showStatus('נשלח לתמלול...');
                    const service = elements.serviceSelector.value;
                    transcriptResult = service === 'openai' ? await performOpenAiTranscription() : await performIvritAiTranscription();
                    displayResults();
                    showStatus('התמלול הושלם בהצלחה! ✅', 'success');
                } catch (error) {
                    console.error('Transcription error:', error);
                    showStatus('שגיאה: ' + error.message, 'error');
                } finally {
                    elements.transcribeButton.disabled = false;
                    elements.loadingSpinner.style.display = 'none';
                }
            });
            
            document.querySelectorAll('.toggle').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    toggle.classList.toggle('active');
                    if (transcriptResult) displayResults();
                });
            });
            
            elements.downloadTxtButton.addEventListener('click', () => downloadHandler(false));
            elements.downloadVttButton.addEventListener('click', () => downloadHandler(true));
            elements.copyButton.addEventListener('click', () => navigator.clipboard.writeText(elements.transcriptText.textContent));
            elements.resetButton.addEventListener('click', resetUI);
        }

        // --- APP INITIALIZATION ---
        function initApp() {
            ['apiKey', 'proxyUrl', 'endpointId', 'runpodApiKey', 'serviceSelector'].forEach(id => {
                const savedValue = storage.load(id);
                if (savedValue && elements[id]) elements[id].value = savedValue;
            });
            elements.serviceSelector.dispatchEvent(new Event('change'));
            setupEventListeners();
            checkButtonsState();
            console.log('App loaded successfully! 🚀');
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
