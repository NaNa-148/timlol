<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>תמלול עברית AI - Hebrew Audio Transcription</title>
    <meta name="description" content="תמלול אודיו לטקסט בעברית באמצעות בינה מלאכותית">
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <!-- מסך כניסה עם סיסמה -->
    <div class="password-screen" id="passwordScreen">
        <div class="password-container">
            <h2 class="password-title">🔐 כניסה למערכת</h2>
            <input type="password" id="passwordInput" class="password-input" placeholder="הזן סיסמה">
            <button class="password-button" id="passwordButton">כניסה</button>
            <div class="password-error" id="passwordError">סיסמה שגויה</div>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <div class="header">
            <h1 class="title">תמלול עברית AI</h1>
            <p class="subtitle">המר אודיו לטקסט בעברית באמצעות בינה מלאכותית מתקדמת</p>
        </div>

        <!-- כפתור הגדרות למעלה -->
        <button class="settings-button" id="settingsButton">
            ⚙️ הגדרות חיבור
        </button>

        <div class="info-box not-ready" id="statusBox">
            <div class="info-text" id="statusText">⚠️ לא מוכן לשימוש</div>
            <div class="info-subtext" id="statusSubtext">יש להגדיר פרטי התחברות לפחות לאחד מהשירותים</div>
        </div>

        <!-- בחירת שירות בקוביות חדש -->
        <div class="service-selection">
            <label class="option-label">🤖 בחר שירות תמלול</label>
            <div class="service-cards">
                <!-- ivrit בצד ימין וברירת מחדל -->
                <div class="service-card ivrit selected" data-service="ivrit-ai">
                    <span class="service-badge">מומלץ לעברית</span>
                    <span class="service-status not-configured" id="ivritStatus">❌ לא מוגדר</span>
                    <span class="service-icon">🇮🇱</span>
                    <div class="service-name">ivrit</div>
                    <div class="service-description">
                        מודל מתמחה בשפה העברית עם דיוק מקסימלי
                    </div>
                    <div class="service-features">
                        <div class="service-feature">מותאם במיוחד לעברית</div>
                        <div class="service-feature">זיהוי ניבים וביטויים</div>
                        <div class="service-feature">תמיכה בקבצים עד 100MB</div>
                        <div class="service-feature">עיבוד על GPU מהיר</div>
                    </div>
                    <div class="service-config-note">להגדרת השירות לחץ על כפתור ההגדרות למעלה</div>
                </div>
                
                <div class="service-card openai" data-service="openai">
                    <span class="service-status not-configured" id="openaiStatus">❌ לא מוגדר</span>
                    <span class="service-icon">🌐</span>
                    <div class="service-name">OpenAI Whisper</div>
                    <div class="service-description">
                        מודל תמלול מתקדם עם תמיכה ב-20+ שפות
                    </div>
                    <div class="service-features">
                        <div class="service-feature">זיהוי אוטומטי של שפה</div>
                        <div class="service-feature">דיוק גבוה בעברית ואנגלית</div>
                        <div class="service-feature">עד 25MB לקובץ</div>
                        <div class="service-feature">מהירות עיבוד גבוהה</div>
                    </div>
                    <div class="service-config-note">להגדרת השירות לחץ על כפתור ההגדרות למעלה</div>
                </div>
            </div>
        </div>

        <!-- בחירת שפה לOpenAI -->
        <div class="language-selection" id="languageSelectionDiv" style="display: none;">
            <label class="option-label">🌐 שפת תמלול (OpenAI בלבד)</label>
            <select id="languageSelect" class="api-input language-select">
                <option value="auto">זיהוי אוטומטי</option>
                <option value="he" selected>עברית</option>
                <option value="en">English</option>
                <option value="ar">العربية</option>
                <option value="ru">Русский</option>
                <option value="es">Español</option>
                <option value="fr">Français</option>
                <option value="de">Deutsch</option>
                <option value="it">Italiano</option>
                <option value="pt">Português</option>
                <option value="zh">中文</option>
                <option value="ja">日本語</option>
                <option value="ko">한국어</option>
                <option value="hi">हिन्दी</option>
                <option value="tr">Türkçe</option>
                <option value="pl">Polski</option>
                <option value="nl">Nederlands</option>
                <option value="sv">Svenska</option>
                <option value="da">Dansk</option>
                <option value="no">Norsk</option>
                <option value="fi">Suomi</option>
            </select>
        </div>

        <!-- Select מוסתר לתאימות עם הקוד הקיים -->
        <select id="transcriptionService" style="display: none;">
            <option value="openai">OpenAI Whisper</option>
            <option value="ivrit-ai" selected>ivrit.ai (מומחה לעברית)</option>
        </select>

        <!-- חלון הגדרות Modal -->
        <div class="settings-modal" id="settingsModal">
            <div class="settings-content">
                <div class="settings-header">
                    <h2 class="settings-title">⚙️ הגדרות</h2>
                    <button class="close-settings" id="closeSettings">✕</button>
                </div>

                <!-- הגדרות OpenAI - תמיד מוצג -->
                <div class="settings-section" id="openAiSettings">
                    <h3 class="settings-section-title">🌐 OpenAI Whisper</h3>
                    <div class="option-group">
                        <label class="option-label">🔑 מפתח OpenAI API</label>
                        <input type="password" id="apiKey" class="api-input" placeholder="sk-proj-..." 
                               autocomplete="off" spellcheck="false">
                        <small style="color: #666;">המפתח נשמר בזיכרון הדפדפן ולא נשלח לאף מקום אחר</small>
                    </div>
                </div>

                <!-- הגדרות ivrit - תמיד מוצג -->
                <div class="settings-section" id="ivritAiSettings">
                    <h3 class="settings-section-title">🇮🇱 ivrit</h3>
                    <div class="option-group">
                        <label class="option-label">🚀 הגדרות חיבור</label>
                        
                        <input type="password" id="runpodApiKey" class="api-input" placeholder="RunPod API Key" 
                               autocomplete="off" spellcheck="false">
                        
                        <input type="text" id="endpointId" class="api-input" placeholder="Endpoint ID (לדוגמה: p8ku15ov44l7vj)" 
                               autocomplete="off" spellcheck="false">
                        
                        <input type="url" id="workerUrl" class="api-input" placeholder="כתובת Cloudflare Worker" 
                               autocomplete="off" spellcheck="false">
                        
                        <small style="color: #666;">הנתונים נשמרים בדפדפן ולא נשלחים למקום אחר</small>
                    </div>
                </div>

                <button class="button process-button" id="saveSettings" style="width: 100%; margin-top: 20px;">
                    💾 שמור הגדרות
                </button>
            </div>
        </div>

        <!-- אזורי העלאה -->
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">🎤</div>
            <div class="upload-text">גרור קובץ אודיו לכאן או לחץ לבחירה</div>
            <div class="upload-subtext">תומך ב-MP3, WAV, M4A, MP4, WEBM, FLAC</div>
            <button class="button select-button" onclick="document.getElementById('fileInput').click();">בחר קובץ</button>
            <input type="file" id="fileInput" class="file-input" accept="audio/*,video/*">
        </div>

        <!-- מידע על הקובץ עם כפתור X -->
        <div class="file-info" id="fileInfo">
            <button class="remove-file-btn" id="removeFileBtn" title="הסר קובץ">✕</button>
            <div class="file-name" id="fileName"></div>
            <div class="file-size" id="fileSize"></div>
        </div>

        <div class="audio-preview" id="audioPreview">
            <div class="audio-controls">
                <audio controls class="audio-player" id="audioPlayer"></audio>
            </div>
            <div class="canvas-container">
                <canvas class="waveform-canvas" id="waveformCanvas" width="600" height="100"></canvas>
            </div>
        </div>

        <div class="options">
            <div class="option-group">
                <label class="option-label">🔧 הגדרות עיבוד אודיו</label>
                
                <div class="option-row">
                    <span>הפעל מסנן רעשים</span>
                    <div class="toggle active" id="noiseReductionToggle"></div>
                </div>
                
                <div class="slider-container" id="noiseSliderContainer">
                    <span>רמת מסנן רעשים:</span>
                    <input type="range" class="slider" id="noiseReductionLevel" min="0" max="100" value="30">
                    <span class="slider-value" id="noiseReductionValue">30%</span>
                </div>
                
                <div class="option-row">
                    <span>נרמול עוצמת קול</span>
                    <div class="toggle active" id="normalizeToggle"></div>
                </div>
                
                <div class="slider-container" id="volumeSliderContainer">
                    <span>עוצמת קול יעד:</span>
                    <input type="range" class="slider" id="volumeLevel" min="50" max="150" value="100">
                    <span class="slider-value" id="volumeValue">100%</span>
                </div>

                <button class="button process-button" id="processButton" disabled style="width: 100%; margin-top: 15px; padding: 12px;">עבד אודיו</button>
            </div>

            <div class="option-group">
                <label class="option-label">📝 הגדרות תמלול</label>
                
                <div class="option-row">
                    <span>חותמות זמן</span>
                    <div class="toggle" id="timestampToggle"></div>
                </div>
                
                <div class="option-row">
                    <span>זיהוי משתתפים</span>
                    <div class="toggle" id="speakerToggle"></div>
                </div>
                
                <div class="option-row">
                    <span>הצג כפסקאות</span>
                    <div class="toggle" id="paragraphToggle"></div>
                </div>
            </div>
        </div>

        <button class="button transcribe-button" id="transcribeButton" disabled>התחל תמלול</button>

        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="loading-spinner" id="loadingSpinner"></div>
        <div class="status" id="status"></div>

        <div class="result-area" id="resultArea">
            <div class="result-header">
                <div class="result-title">תוצאת התמלול</div>
                <div class="result-actions">
                    <button class="button copy-button" id="copyButton">העתק הכל</button>
                    <button class="button download-button" id="downloadTxtButton">הורד כ-TXT</button>
                    <button class="button download-button vtt" id="downloadVttButton">הורד כ-VTT</button>
                </div>
            </div>
            <div class="result-actions" style="margin-top: 15px; justify-content: flex-end;">
                <select id="improveModelSelect" class="api-input" style="width: auto; margin-bottom: 0;">
                    <option value="gpt-4o" selected>GPT-4o</option>
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                </select>
                <button class="button process-button" id="improveButton" style="display: none;">🔧 תיקון אוטומטי</button>
            </div>
            <div class="transcript-text" id="transcriptText" contenteditable="true" style="margin-top: 15px;"></div>
            <div class="transcript-text" id="improvedText" contenteditable="true" style="display: none; margin-top: 15px; border-right-color: #28a745;">
                <div style="font-weight: bold; margin-bottom: 10px; color: #28a745;">✨ טקסט מתוקן:</div>
            </div>
        </div>

        <button id="resetButton" class="reset-button">איפוס מלא</button>
    </div>

    <!-- Load scripts -->
   <script>
    // ביטול מוחלט של כל ההתראות - חייב להיות ראשון!
    (function() {
        // מחליף את window.alert
        window.alert = function() { return false; };
        
        // מטפל בשגיאות
        window.addEventListener('error', function(e) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            return true;
        }, true);
        
        // מטפל בהבטחות שנכשלו
        window.addEventListener('unhandledrejection', function(e) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            return true;
        }, true);
        
        // משתיק console
        if (typeof console !== 'undefined') {
            const noop = function() {};
            console.error = noop;
            console.warn = noop;
            console.log = noop;
        }
    })();
</script>

<script src="scripts/storage.js"></script>
<script src="scripts/audio-processor.js"></script>
<script src="scripts/waveform.js"></script>
<script src="scripts/ui-helpers.js"></script>
<script src="scripts/file-handler.js"></script>
<script src="scripts/ivrit-transcription.js"></script> <!-- הועבר לפני transcription.js -->
<script src="scripts/transcription.js"></script> <!-- עכשיו אחרי ivrit-transcription.js -->
<script src="scripts/text-improvement.js"></script>
<script src="scripts/export-download.js"></script>
<script src="scripts/event-listeners.js"></script>
<script src="scripts/main.js"></script>
    
    <!-- סקריפט לטיפול בסיסמה ואתחול -->
    <script>
        // השתקת כל השגיאות של פונקציות לא מוגדרות
        window.addEventListener('error', function(e) {
            if (e.message && (e.message.includes('is not defined') || e.message.includes('נשיאה בטעינת'))) {
                e.preventDefault();
                e.stopPropagation();
                return true;
            }
        }, true);
        
        // השתקת console errors
        const originalError = console.error;
        console.error = function() {
            const args = Array.from(arguments);
            if (args.some(arg => String(arg).includes('is not defined'))) {
                return;
            }
            originalError.apply(console, arguments);
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            const passwordScreen = document.getElementById('passwordScreen');
            const passwordInput = document.getElementById('passwordInput');
            const passwordButton = document.getElementById('passwordButton');
            const passwordError = document.getElementById('passwordError');
            const mainContainer = document.getElementById('mainContainer');
            
            // בדיקה אם כבר נכנסו בעבר
            const isAuthenticated = sessionStorage.getItem('authenticated') === 'true';
            
            if (isAuthenticated) {
                if (passwordScreen) passwordScreen.style.display = 'none';
                if (mainContainer) mainContainer.style.display = 'block';
                
                // אתחול המערכת אחרי הכניסה
                setTimeout(function() {
                    if (typeof checkConfigurationStatus === 'function') {
                        checkConfigurationStatus();
                    }
                    initializeEventHandlers();
                }, 100);
                return;
            }
            
            // הצגת מסך סיסמה
            if (passwordScreen) {
                passwordScreen.style.display = 'flex';
            }
            if (mainContainer) {
                mainContainer.style.display = 'none';
            }
            
            if (passwordButton && passwordInput) {
                // בדיקת סיסמה בלחיצת כפתור
                passwordButton.addEventListener('click', function() {
                    if (passwordInput.value === '148148') {
                        sessionStorage.setItem('authenticated', 'true');
                        if (passwordScreen) passwordScreen.style.display = 'none';
                        if (mainContainer) mainContainer.style.display = 'block';
                        if (passwordError) passwordError.style.display = 'none';
                        
                        // אתחול המערכת לאחר כניסה
                        setTimeout(function() {
                            if (typeof checkConfigurationStatus === 'function') {
                                checkConfigurationStatus();
                            }
                            initializeEventHandlers();
                        }, 100);
                    } else {
                        if (passwordError) passwordError.style.display = 'block';
                        passwordInput.value = '';
                        passwordInput.focus();
                    }
                });
                
                // בדיקת סיסמה בלחיצת Enter
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        passwordButton.click();
                    }
                });
                
                // פוקוס אוטומטי על שדה הסיסמה
                setTimeout(function() {
                    passwordInput.focus();
                }, 100);
            }
        });
        
        // פונקציה לאתחול כל המאזינים אחרי הכניסה
        function initializeEventHandlers() {
            // כפתור הסרת קובץ
            const removeFileBtn = document.getElementById('removeFileBtn');
            if (removeFileBtn) {
                removeFileBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (confirm('האם להסיר את הקובץ?')) {
                        // איפוס הקבצים
                        if (typeof clearFiles === 'function') {
                            clearFiles();
                        } else {
                            // איפוס ידני אם הפונקציה לא זמינה
                            selectedFile = null;
                            processedFile = null;
                            
                            const fileInfo = document.getElementById('fileInfo');
                            const audioPreview = document.getElementById('audioPreview');
                            const audioPlayer = document.getElementById('audioPlayer');
                            const fileInput = document.getElementById('fileInput');
                            
                            if (fileInfo) fileInfo.style.display = 'none';
                            if (audioPreview) audioPreview.style.display = 'none';
                            if (audioPlayer) audioPlayer.src = '';
                            if (fileInput) fileInput.value = '';
                            
                            if (typeof clearWaveform === 'function') {
                                clearWaveform();
                            }
                            if (typeof checkButtonsState === 'function') {
                                checkButtonsState();
                            }
                        }
                        
                        if (typeof showStatus === 'function') {
                            showStatus('הקובץ הוסר', 'success');
                            setTimeout(function() {
                                if (typeof hideStatus === 'function') {
                                    hideStatus();
                                }
                            }, 2000);
                        }
                    }
                });
            }
            
            // קוביות בחירת שירות
            const serviceCards = document.querySelectorAll('.service-card');
            serviceCards.forEach(card => {
                card.addEventListener('click', function() {
                    // הסרת בחירה מכל הכרטיסים
                    serviceCards.forEach(c => c.classList.remove('selected'));
                    
                    // הוספת בחירה לכרטיס הנוכחי
                    this.classList.add('selected');
                    
                    // עדכון הערך בselect המוסתר
                    const service = this.dataset.service;
                    const transcriptionSelect = document.getElementById('transcriptionService');
                    if (transcriptionSelect) {
                        transcriptionSelect.value = service;
                        const event = new Event('change', { bubbles: true });
                        transcriptionSelect.dispatchEvent(event);
                    }
                    
                    // עדכון תצוגת בחירת שפה
                    const languageSelectionDiv = document.getElementById('languageSelectionDiv');
                    if (languageSelectionDiv) {
                        languageSelectionDiv.style.display = service === 'openai' ? 'block' : 'none';
                    }
                    
                    if (typeof checkButtonsState === 'function') {
                        checkButtonsState();
                    }
                });
            });
            
            // כפתור הגדרות - תמיד במרכז המסך
            const settingsButton = document.getElementById('settingsButton');
            const settingsModal = document.getElementById('settingsModal');
            const closeSettings = document.getElementById('closeSettings');
            const saveSettings = document.getElementById('saveSettings');
            
            if (settingsButton && settingsModal) {
                settingsButton.addEventListener('click', function() {
                    settingsModal.classList.add('active');
                });
            }
            
            if (closeSettings && settingsModal) {
                closeSettings.addEventListener('click', function() {
                    settingsModal.classList.remove('active');
                });
            }
            
            if (settingsModal) {
                settingsModal.addEventListener('click', function(e) {
                    if (e.target === settingsModal) {
                        settingsModal.classList.remove('active');
                    }
                });
            }
            
            if (saveSettings) {
                saveSettings.addEventListener('click', function() {
                    // שמירת הגדרות OpenAI
                    const apiKey = document.getElementById('apiKey');
                    if (apiKey && apiKey.value.trim()) {
                        if (typeof storage !== 'undefined' && storage.saveApiKey) {
                            storage.saveApiKey(apiKey.value.trim());
                        }
                    }
                    
                    // שמירת הגדרות ivrit.ai
                    const runpodApiKey = document.getElementById('runpodApiKey');
                    const endpointId = document.getElementById('endpointId');
                    const workerUrl = document.getElementById('workerUrl');
                    
                    if (runpodApiKey && endpointId && workerUrl) {
                        const runpod = runpodApiKey.value.trim();
                        const endpoint = endpointId.value.trim();
                        const worker = workerUrl.value.trim();
                        
                        if (runpod && endpoint && worker) {
                            if (typeof storage !== 'undefined' && storage.saveIvritAiCredentials) {
                                storage.saveIvritAiCredentials(runpod, endpoint, worker);
                            }
                        }
                    }
                    
                    // סגירת החלון
                    if (settingsModal) settingsModal.classList.remove('active');
                    
                    // עדכון מצב כפתורים
                    if (typeof checkButtonsState === 'function') {
                        checkButtonsState();
                    }
                    if (typeof checkConfigurationStatus === 'function') {
                        checkConfigurationStatus();
                    }
                    
                    // הודעת הצלחה
                    if (typeof showStatus === 'function') {
                        showStatus('ההגדרות נשמרו בהצלחה ✓', 'success');
                        setTimeout(function() {
                            if (typeof hideStatus === 'function') {
                                hideStatus();
                            }
                        }, 3000);
                    }
                });
            }
        }
    </script>
</body>
</html>
